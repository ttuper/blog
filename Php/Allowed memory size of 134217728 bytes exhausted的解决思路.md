**问题场景**  
对接招商上传图片并替换内容中图片地址时，php进程抛出如下错误：

	Allowed memory size of 134217728 bytes exhausted

查了下网上给出的答案主要有以下两种：  
1、修改php.ini中的配置

	#修改前
	memory_limit = 128M
	#修改后
	memory_limit = 2048M

2、在代码开始处加上内存限制语句  

	@ini_set('memory_limit', '2048M')

这个方法和第一个类似，只不过这个方法只在该运行时时有效，程序执行完就失效了

3、此时，还有第三种方法，在第三种方法实在不行的时候才应当考虑上面两种，即查看自己程序代码中是不是有消耗内存的地方，并对其进行优化。

这里给一个我在当前场景中是如何解决的：
![招商上传图片接口](https://upload-images.jianshu.io/upload_images/9899281-680562d418751138.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
可以看到上图红框框中是要给招商图片的base64流的，由于我并没有考虑内存的限制，在上传时无限制的批量上传，当list中超过一定数量的base64文件流后，就会导致内存溢出。
找到问题解决问题，针对批量上传的图片较多，所以这里可以将获取到的图片数组分批上传，再将招商的结果合并即可。

做了上述更改后又报内存溢出了：
这里图片上传分两步：第一步找到content里面的所有img，赋值给一个变量，并且都是base64过的，也就是说有多少图片这个变量就有多大，占用的内存也多；  
然后第二步以前是一股脑全部批量发过去么，然后就说内存溢出，我这里改了当时，一张一张传，后来今天又内存溢出，就跟踪那里内存暴涨呗，然后就跟踪到第一步，然后今天把第一步的base64环节放到第二步了，第二步一张一张传的时候再获取图片内容再base64转码一下，相当于不一股脑先全部获取图片内容全部转码赋给一个变量了，变量占内存么不是

后续如何优化持续更新中......
